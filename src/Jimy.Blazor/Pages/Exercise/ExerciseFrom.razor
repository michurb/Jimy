@page "/exercises/create"
@page "/exercises/edit/{Id:int}"
@using System.ComponentModel.DataAnnotations
@using Jimy.Blazor.Services
@using Jimy.Business.DTOs
@inject ApiService ApiService
@inject NavigationManager NavigationManager

<h1 class="text-2xl font-bold mb-4">@(_isEditing ? "Edit" : "Create") Exercise</h1>

<EditForm Model="_exercise" OnValidSubmit="HandleSubmit" class="max-w-md">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-4">
        <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Name</label>
        <InputText id="name" @bind-Value="_exercise.Name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
        <ValidationMessage For="@(() => _exercise.Name)" />
    </div>

    <div class="mb-4">
        <label for="description" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
        <InputTextArea id="description" @bind-Value="_exercise.Description" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
        <ValidationMessage For="@(() => _exercise.Description)" />
    </div>

    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
        @(_isEditing ? "Update" : "Create") Exercise
    </button>
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }

    private bool _isEditing => Id.HasValue;
    private ExerciseFormModel _exercise = new();

    protected override async Task OnInitializedAsync()
    {
        if (_isEditing)
        {
            var exercise = await ApiService.GetExerciseAsync(Id.Value);
            _exercise.Name = exercise.Name;
            _exercise.Description = exercise.Description;
        }
    }

    private async Task HandleSubmit()
    {
        if (_isEditing)
        {
            await ApiService.UpdateExerciseAsync(Id.Value, new UpdateExerciseDto(_exercise.Name, _exercise.Description));
        }
        else
        {
            await ApiService.CreateExerciseAsync(new CreateExerciseDto(_exercise.Name, _exercise.Description));
        }

        NavigationManager.NavigateTo("/exercises");
    }

    public class ExerciseFormModel
    {
        [Required]
        [StringLength(100, ErrorMessage = "Name is too long.")]
        public string Name { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Description is too long.")]
        public string Description { get; set; } = string.Empty;
    }
}